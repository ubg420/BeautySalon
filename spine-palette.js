"use strict";class SpinePalette{constructor(e,t){this._palette=new Uint8Array(t*e*4),this._enable=!1,this._indexSize=e,this._paletteNumber=t,this._slotPalette={},this._slotPaletteOffset={},this._paletteTexture=null,this._c3PaletteTexture=null,this._uploadNeeded=!1,this._entryUploadNeeded=new Array(t),this._palette.fill(255),this._entryUploadNeeded.fill(!1)}get palette(){return this._palette}get enable(){return this._enable}get indexSize(){return this._indexSize}get paletteNumber(){return this._paletteNumber}set enable(e){this._enable=e}get slotPalette(){return this._slotPalette}get slotPaletteOffset(){return this._slotPaletteOffset}get paletteTexture(){return this._paletteTexture}get uploadNeeded(){return this._uploadNeeded}set uploadNeeded(e){this._uploadNeeded=e}get entryUploadNeeded(){return this._entryUploadNeeded}createPaletteTexture(e){this._c3PaletteTexture=e.CreateDynamicTexture(this.indexSize,this.paletteNumber,{mipMap:!1,sampling:"nearest",pixelFormat:"rgba8",wrapX:"repeat",wrapY:"repeat"}),this._paletteTexture=this._c3PaletteTexture._texture}setSlotPalette(e,t){(t<0||t>=this.paletteNumber)&&(t=0),this._slotPalette[e]=Math.floor(t)}setSlotPaletteOffset(e,t){this._slotPaletteOffset[e]=Math.floor(t)}getSlotPalette(e){return this.slotPalette.hasOwnProperty(e)?this._slotPalette[e]:0}setColor(e,t,i){if(t<0||t>this.indexSize-1)return;const l=globalThis.spineBatcher;this._palette[e*this.indexSize*4+4*t+0]=255*l.getRValue(i),this._palette[e*this.indexSize*4+4*t+1]=255*l.getGValue(i),this._palette[e*this.indexSize*4+4*t+2]=255*l.getBValue(i),this._palette[e*this.indexSize*4+4*t+3]=255*l.getAValue(i),this.uploadNeeded=!0}setDefaultColors(e,t,i){let l=[];8==this.indexSize?l=["FF000000","FF55415F","FF646964","FFD77355","FF508CD7","FF64B964","FFE6C86E","FFDCF5FF"]:16==this.indexSize?l=["FF140C1C","FF442434","FF30346D","FF4E4A4F","FF854C30","FF346524","FFD04648","FF757161","FF597DCE","FFD27D2C","FF8595A1","FF6DAA2C","FFD2AA99","FF6DC2CA","FFDAD45E","FFDEEED6"]:32==this.indexSize&&(l=["FFbe4a2f","FFd77643","FFead4aa","FFe4a672","FFb86f50","FF733e39","FF3e2731","FFa22633","FFe43b44","FFf77622","FFfeae34","FFfee761","FF63c74d","FF3e8948","FF265c42","FF193c3e","FF124e89","FF0099db","FF2ce8f5","FFffffff","FFc0cbdc","FF8b9bb4","FF5a6988","FF3a4466","FF262b44","FF181425","FFff0044","FF68386c","FFb55088","FFf6757a","FFe8b796","FFc28569"]);for(let s=0;s<l.length;s++){let a=this.convertHexToDecimal(l[s]);this._palette[e*this.indexSize*4+4*s+0]=a.r*t,this._palette[e*this.indexSize*4+4*s+1]=a.g*t,this._palette[e*this.indexSize*4+4*s+2]=a.b*t,this._palette[e*this.indexSize*4+4*s+3]=a.a*i}this.uploadNeeded=!0}convertHexToDecimal(e){let t=parseInt(e.substring(0,2),16);return{r:parseInt(e.substring(2,4),16),g:parseInt(e.substring(4,6),16),b:parseInt(e.substring(6,8),16),a:t}}setShaderEnable(e){this.enable?e.setUniformf("paletteEnable",1):e.setUniformf("paletteEnable",0)}upload(e,t){let i=t.getParameter(t.ACTIVE_TEXTURE),l=t.getParameter(t.TEXTURE_BINDING_2D);if(t.activeTexture(e),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.bindTexture(t.TEXTURE_2D,this._paletteTexture),this.countEntries()>this.indexSize/8)t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.indexSize,this.paletteNumber,0,t.RGBA,t.UNSIGNED_BYTE,this._palette),this.entryUploadNeeded.fill(!1);else{let e=[];for(let i=0;i<this.entryUploadNeeded.length;i++)this.entryUploadNeeded[i]&&(e.push(this.palette.slice(i*this.indexSize*4,i*this.indexSize*4+4*this.indexSize)),t.texSubImage2D(t.TEXTURE_2D,0,0,i,this.indexSize,1,t.RGBA,t.UNSIGNED_BYTE,e[e.length-1]),this.entryUploadNeeded[i]=!1)}t.activeTexture(i),t.bindTexture(t.TEXTURE_2D,l)}countEntries(){let e=0;for(const t of this.entryUploadNeeded)t&&e++;return e}}globalThis.SpinePalette||(globalThis.SpinePalette=SpinePalette);